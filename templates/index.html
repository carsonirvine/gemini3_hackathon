<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UVic Course Lookup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #3b82f6;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .row-animate {
            animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center py-12 px-4">

    <div class="w-full max-w-lg bg-white shadow-2xl rounded-3xl p-6 sm:p-8">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-1 text-center">UVic Course Lookup</h1>
        <p class="text-gray-500 text-center mb-8">Real-time seat and schedule scraper</p>
        
        <div id="searchRows" class="space-y-3 mb-4">
            </div>

        <div class="flex justify-between items-center mb-8 h-6">
            <button onclick="addRow()" id="addBtn" class="text-blue-600 font-bold text-sm hover:text-blue-800 transition-colors">
                + Add a box
            </button>
            <button onclick="resetApp()" class="text-gray-400 font-bold text-sm hover:text-red-500 transition-colors">
                Reset
            </button>
        </div>

        <button onclick="startScrape()" id="btn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-bold shadow-lg shadow-blue-200 transition-all active:scale-95 mb-8">
            Fetch All Courses
        </button>

        <div id="status" class="hidden mb-6 p-4 rounded-xl text-center font-semibold"></div>
        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        const all_subjects = ['ADMN', 'AE', 'AHVS', 'ANTH', 'ART', 'ASL', 'ASTR', 'ATWP', 'BCMB', 'BIOC', 'BIOL', 'BME', 'BUS', 'CD', 'CE', 'CHEM', 'CIVE', 'CNPY', 'COM', 'CS', 'CSC', 'CSPT', 'CW', 'CYC', 'DR', 'ECE', 'ECON', 'ED-D', 'ED-P', 'EDCI', 'ENGR', 'ENSH', 'ENT', 'EOS', 'EPHE', 'ER', 'ES', 'EUS', 'FA', 'FORB', 'FRAN', 'GDS', 'GEOG', 'GMST', 'GNDR', 'GREE', 'GRS', 'GS', 'HINF', 'HLTH', 'HSTR', 'HUMA', 'ICDG', 'IED', 'IGOV', 'IN', 'INDW', 'INGH', 'INTD', 'INTS', 'IS', 'ISP', 'ITAL', 'LAS', 'LATI', 'LAW', 'LING', 'MATH', 'MBA', 'MDIA', 'MECH', 'MEDI', 'MEDS', 'MGB', 'MICR', 'MUS', 'NRSC', 'NUED', 'NUHI', 'NUNP', 'NURA', 'NURS', 'PAAS', 'PHIL', 'PHSP', 'PHYS', 'POLI', 'PSYC', 'RCS', 'SCIE', 'SDH', 'SENG', 'SJS', 'SLST', 'SOCI', 'SOCW', 'SPAN', 'STAT', 'TCA', 'THEA', 'TS', 'WRIT'];
        const MAX_BOXES = 6;

        window.onload = () => addRow();

        function updateAddButton() {
            const count = document.querySelectorAll('.course-row').length;
            const addBtn = document.getElementById('addBtn');
            if (count >= MAX_BOXES) {
                addBtn.classList.add('invisible');
            } else {
                addBtn.classList.remove('invisible');
            }
        }

        function addRow() {
            const container = document.getElementById('searchRows');
            const rowCount = container.children.length;
            
            if (rowCount >= MAX_BOXES) return;

            const row = document.createElement('div');
            row.className = "flex gap-2 course-row row-animate items-center";
            row.innerHTML = `
                <input type="text" placeholder="eg. CSC" 
                    class="subject-input flex-1 px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-blue-500 outline-none uppercase font-semibold transition-all">
                <input type="text" placeholder="eg. 105" 
                    class="number-input flex-1 px-4 py-3 border-2 border-gray-100 rounded-xl focus:border-blue-500 outline-none font-semibold transition-all">
                <button onclick="this.parentElement.remove(); updateAddButton();" class="text-gray-300 hover:text-red-500 font-bold px-2 text-xl">Ã—</button>
            `;
            container.appendChild(row);
            updateAddButton();
        }

        function resetApp() {
            document.getElementById('searchRows').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            document.getElementById('status').classList.add('hidden');
            addRow();
        }

        function getStatusColor(fraction) {
            if (!fraction || fraction === "N/A") return "text-gray-500 bg-gray-100 border-gray-200";
            const [rem, total] = fraction.split('/').map(Number);
            if (total === 0 || rem === 0) return "text-red-700 bg-red-50 border-red-200";
            const percentLeft = (rem / total) * 100;
            if (percentLeft >= 25) return "text-emerald-700 bg-emerald-50 border-emerald-200";
            return percentLeft > 0 ? "text-amber-700 bg-amber-50 border-amber-200" : "text-red-700 bg-red-50 border-red-200";
        }

        function getSectionTheme(section) {
            const char = section.charAt(0).toUpperCase();
            if (char === 'B') return { label: "LAB", border: "border-purple-500", bg: "bg-purple-50", text: "text-purple-700" };
            if (char === 'T') return { label: "TUTORIAL", border: "border-orange-500", bg: "bg-orange-50", text: "text-orange-700" };
            return { label: "LECTURE", border: "border-green-500", bg: "bg-green-50", text: "text-green-700" };
        }

        async function startScrape() {
            const rows = document.querySelectorAll('.course-row');
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            const resultsDiv = document.getElementById('results');

            resultsDiv.innerHTML = "";
            btn.disabled = true;
            btn.innerText = "Processing...";
            status.className = "mb-6 p-4 rounded-xl text-center font-semibold bg-blue-50 text-blue-700 block animate-pulse";
            status.innerHTML = `<div class="spinner"></div> <span>Scraping all courses concurrently...</span>`;

            // 1. Gather all valid requests into an array of Promises
            const scrapePromises = Array.from(rows).map(row => {
                const subjectInput = row.querySelector('.subject-input');
                const numInput = row.querySelector('.number-input');
                const subject = subjectInput.value.trim().toUpperCase();
                const courseNum = numInput.value.trim();

                if (!subject) return null; // Skip empty rows

                if (!all_subjects.includes(subject)) {
                    subjectInput.classList.add('border-red-500');
                    return null;
                } else {
                    subjectInput.classList.remove('border-red-500');
                }

                // Return the fetch promise
                return fetch('/scrape', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subject: subject, course_num: courseNum })
                })
                .then(res => res.json())
                .catch(err => {
                    console.error(err);
                    return { status: "error" }; // Return a safe error object so Promise.all doesn't fail completely
                });
            }).filter(p => p !== null); // Remove nulls (skipped rows)

            // 2. Await all requests simultaneously
            try {
                const results = await Promise.all(scrapePromises);

                // 3. Process results as they come in (Order is preserved!)
                results.forEach(result => {
                    if (result && result.status === "success") {
                        result.data.forEach(course => {
                            const seatColor = getStatusColor(course.seats);
                            const theme = getSectionTheme(course.section);
                            const card = document.createElement('div');
                            card.className = `border-l-8 ${theme.border} bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-4`;
                            card.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="flex flex-wrap items-center gap-2 mb-1">
                                            <span class="text-[10px] font-black px-2 py-0.5 rounded border-2 ${theme.border} ${theme.bg} ${theme.text}">${theme.label}</span>
                                            <h3 class="font-bold text-xl text-gray-900">${course.subject} ${course.course}</h3>
                                        </div>
                                        <p class="text-sm font-bold text-gray-400">Section ${course.section} â€¢ CRN ${course.crn}</p>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="text-[9px] uppercase font-bold text-gray-400">Seats</span>
                                        <span class="px-3 py-1 rounded-lg text-sm font-bold border ${seatColor}">${course.seats}</span>
                                    </div>
                                </div>
                                <h4 class="text-gray-700 font-medium mt-3 leading-tight">${course.title}</h4>
                                <div class="text-sm font-semibold text-gray-500 mt-4 bg-gray-50 p-3 rounded-xl border border-gray-100">ðŸ“… ${course.schedule}</div>
                            `;
                            resultsDiv.appendChild(card);
                        });
                    }
                });
            } catch (err) {
                console.error("Batch scrape failed", err);
                status.innerHTML = "Something went wrong.";
                status.className = "mb-6 p-4 rounded-xl text-center font-semibold bg-red-50 text-red-700";
            }

            status.className = "mb-6 p-4 rounded-xl text-center font-semibold bg-emerald-50 text-emerald-700";
            status.innerHTML = "Done! All results loaded.";
            btn.disabled = false;
            btn.innerText = "Fetch All Courses";
        }
    </script>
</body>
</html>